{% extends "layout.html" %}
{% block content %}
<div class="toolbar">
  <div>
    <p class="hint">Exam: {{ exam.title }}</p>
    <h2>Edit question</h2>
  </div>
  <div class="actions">
    <a class="btn ghost" href="{{ url_for('add_question', exam_id=exam.id) }}">Back</a>
  </div>
</div>

<form method="post" enctype="multipart/form-data" class="card">
  <label>Question text
    <textarea name="text" id="question-editor" rows="6" required>{{ question.text|safe }}</textarea>
  </label>
  <label>Type
    <select name="qtype">
      <option value="single" {% if question.qtype == 'single' %}selected{% endif %}>Single choice</option>
      <option value="multiple" {% if question.qtype == 'multiple' %}selected{% endif %}>Multiple choice</option>
    </select>
  </label>
  <label>Image (optional)
    {% if question.image_path %}
      <div class="question-image"><img src="{{ url_for('static', filename=question.image_path) }}" alt="Question image"></div>
      <label class="choice"><input type="checkbox" name="remove_image"> <span>Remove image</span></label>
    {% endif %}
    <input type="file" name="image" accept="image/*">
  </label>
  <p class="hint">Edit options, attach images if needed, and mark the correct answers.</p>
  <div class="grid">
    {% for opt in options %}
      <div class="card">
        <label>Option {{ loop.index }}
          <input type="text" name="option{{ loop.index }}" value="{{ opt.text }}">
        </label>
        {% if opt.image_path %}
          <div class="option-thumb"><img src="{{ url_for('static', filename=opt.image_path) }}" alt="Option image"></div>
          <label class="choice">
            <input type="checkbox" name="remove_option_image{{ loop.index }}">
            <span>Remove option image</span>
          </label>
        {% endif %}
        <label>Image (optional)
          <input type="file" name="option_image{{ loop.index }}" accept="image/*">
        </label>
        <label class="choice">
          <input type="checkbox" name="correct" value="{{ loop.index }}" {% if loop.index0 in correct_indices %}checked{% endif %}>
          <span>Correct</span>
        </label>
      </div>
    {% endfor %}
    {% for idx in range(options|length + 1, 7) %}
      <div class="card">
        <label>Option {{ idx }}
          <input type="text" name="option{{ idx }}">
        </label>
        <label>Image (optional)
          <input type="file" name="option_image{{ idx }}" accept="image/*">
        </label>
        <label class="choice">
          <input type="checkbox" name="correct" value="{{ idx }}">
          <span>Correct</span>
        </label>
      </div>
    {% endfor %}
  </div>
  <label>Reason / Explanation (optional, shown to student after exam)
    <textarea name="reason" rows="2" placeholder="Why this answer is correct, hints, or notes for review">{{ question.reason or "" }}</textarea>
  </label>
  <label>Reason image (optional)
    {% if question.reason_image_path %}
      <div class="question-image"><img src="{{ url_for('static', filename=question.reason_image_path) }}" alt="Reason image"></div>
      <label class="choice"><input type="checkbox" name="remove_reason_image"> <span>Remove reason image</span></label>
    {% endif %}
    <input type="file" name="reason_image" accept="image/*">
  </label>
  <div class="actions">
    <button type="submit">Save question</button>
    <a class="btn ghost" href="{{ url_for('add_question', exam_id=exam.id) }}">Cancel</a>
  </div>
</form>
<script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js" referrerpolicy="origin"></script>
<script>
  tinymce.init({
    selector: '#question-editor',
    menubar: false,
    plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table code help wordcount directionality',
    toolbar: 'fontsizeselect bold italic underline forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image table | rtl ltr | removeformat code',
    height: 280,
    branding: false,
    content_style: 'body { font-family: Arial, sans-serif; font-size: 14px; }',
    directionality: document.dir || 'ltr',
    paste_data_images: true,
    automatic_uploads: true,
    file_picker_types: 'image',
    images_upload_url: '{{ url_for("upload_rte_image") }}',
    images_upload_credentials: false
  });
</script>
{% endblock %}
